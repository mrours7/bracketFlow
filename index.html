<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BracketFlow — Organisateur de Tournois</title>
  <meta name="description" content="BracketFlow : crée des poules, saisis les scores, lance un arbre à élimination directe." />
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <!-- NAVBAR -->
  <header class="navbar">
    <div class="container nav-inner">
      <a class="brand" href="#" aria-label="BracketFlow - Accueil">
        <span class="brand-mark" aria-hidden="true"></span>
        <span class="brand-text">
          <span class="brand-name">BracketFlow</span>
          <span class="brand-tag">Poules • Scores • Élimination</span>
        </span>
      </a>

      <nav class="nav-actions" aria-label="Actions rapides">
        <span class="status" title="État du tournoi">
          <span class="status-dot" id="statusDot"></span>
          <span id="statusText">Prêt</span>
        </span>

        <button class="btn btn-ghost" id="demoBtnTop" type="button">Démo</button>
        <button class="btn btn-ghost" id="exportBtnTop" type="button">Exporter</button>
        <button class="btn btn-primary" id="importBtnTop" type="button">Importer</button>
      </nav>
    </div>
  </header>

  <!-- MAIN -->
  <main class="container page">
    <!-- Sidebar -->
    <aside class="card">
      <div class="card-hd">
        <div>
          <h2>Participants</h2>
          <p class="sub">Ajoute, mélange, importe rapidement.</p>
        </div>
        <span class="pill" id="countPill">0</span>
      </div>

      <div class="card-bd">
        <div class="row">
          <input id="nameInput" class="input" placeholder="Nom du participant (ex: Alex)" />
          <button class="btn btn-primary" id="addBtn" type="button">Ajouter</button>
        </div>

        <div class="row">
          <button class="btn btn-ghost" id="shuffleBtn" type="button">Tirage aléatoire</button>
          <button class="btn btn-danger" id="clearBtn" type="button">Tout effacer</button>
        </div>

        <div class="row">
          <input id="bulkInput" class="input" placeholder="Import : noms séparés par virgule" />
          <button class="btn btn-ghost" id="bulkBtn" type="button">Importer</button>
        </div>

        <div class="list" id="participantsList"></div>

        <hr class="sep" />

        <div class="section-title">
          <h3>Créer des poules</h3>
          <span class="hint">Round-robin</span>
        </div>

        <div class="row">
          <label class="label">Nb poules</label>
          <select id="groupsCount" class="select">
            <option value="2">2</option><option value="3">3</option><option value="4">4</option>
            <option value="5">5</option><option value="6">6</option><option value="8">8</option>
          </select>

          <label class="label">Qualifiés / poule</label>
          <select id="qualifyPerGroup" class="select">
            <option value="1">1</option><option value="2" selected>2</option><option value="3">3</option><option value="4">4</option>
          </select>
        </div>

        <div class="row">
          <button class="btn btn-primary" id="makeGroupsBtn" type="button">Générer les poules</button>
          <button class="btn btn-ghost" id="resetGroupsBtn" type="button">Réinitialiser</button>
        </div>

        <p class="small">
          Classement : <b>3</b> pts victoire, <b>1</b> pt nul, <b>0</b> pt défaite.
          Départage : points → diff. buts → buts marqués.
        </p>

        <hr class="sep" />

        <div class="section-title">
          <h3>Élimination directe</h3>
          <span class="hint">Auto-bracket</span>
        </div>

        <div class="row">
          <button class="btn btn-success" id="makeBracketBtn" type="button">Créer le bracket</button>
          <button class="btn btn-ghost" id="resetBracketBtn" type="button">Réinitialiser</button>
        </div>

        <p class="small">
          Bracket basé sur les qualifiés (1ers puis 2èmes, etc.).
          BYE ajoutés si nécessaire pour atteindre une puissance de 2.
        </p>

        <input type="file" id="fileInput" accept="application/json" hidden />
      </div>
    </aside>

    <!-- Content -->
    <section class="card">
      <div class="card-hd">
        <div>
          <h2>Tournoi</h2>
          <p class="sub">Poules puis élimination directe.</p>
        </div>
        <span class="pill" id="statusPill">Prêt</span>
      </div>

      <div class="card-bd">
        <div class="grid-2">
          <div>
            <div class="section-title">
              <h3>Poules</h3>
              <span class="hint" id="groupsMeta">—</span>
            </div>
            <div class="stack" id="groupsView"></div>
          </div>

          <div>
            <div class="section-title">
              <h3>Bracket</h3>
              <span class="hint" id="bracketMeta">—</span>
            </div>
            <div class="bracket" id="bracketView"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="container footer-inner">
      <div class="footer-left">
        <div class="footer-brand">
          <span class="brand-mark small" aria-hidden="true"></span>
          <div>
            <div class="footer-title">BracketFlow</div>
            <div class="footer-sub">Organisateur de tournois (HTML • CSS • JS)</div>
          </div>
        </div>
        <div class="footer-note">Astuce : mélange les participants avant de générer les poules.</div>
      </div>

      <div class="footer-right">
        <div class="footer-links">
          <a href="#" id="demoBtn">Charger une démo</a>
          <a href="#" id="exportBtn">Exporter JSON</a>
          <a href="#" id="importBtn">Importer JSON</a>
        </div>
        <div class="footer-copy">© <span id="year"></span> BracketFlow</div>
      </div>
    </div>
  </footer>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
(() => {
  // ----------------- State -----------------
  const state = {
    participants: [],
    groups: null,   // { groups: [{name, players:[], matches:[] }], qualifyPerGroup, createdAt }
    bracket: null   // { rounds: [ [match,...], ...], createdAt }
  };

  // ----------------- Helpers -----------------
  const $ = (sel) => document.querySelector(sel);
  const uid = () => Math.random().toString(36).slice(2, 9) + "-" + Date.now().toString(36);
  const clampInt = (v, d=0) => {
    const n = parseInt(v, 10);
    return Number.isFinite(n) ? n : d;
  };
  const normalizeName = (s) => (s || "").trim().replace(/\s+/g," ");
  const escapeHtml = (str) => (str ?? "").replace(/[&<>"']/g, (m) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));

  function toast(msg){
    const el = $("#toast");
    el.textContent = msg;
    el.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=> el.classList.remove("show"), 2600);
  }

  function shuffle(arr){
    for (let i = arr.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function setStatus(text){
    $("#statusPill").textContent = text;
    $("#statusText").textContent = text;
    const dot = $("#statusDot");
    dot.dataset.state = (text === "Prêt") ? "ready" : (text === "Poules") ? "groups" : "bracket";
  }

  function updateCount(){
    $("#countPill").textContent = state.participants.length;
  }

  // ----------------- Participants -----------------
  function renderParticipants(){
    updateCount();
    const box = $("#participantsList");
    box.innerHTML = "";

    if (state.participants.length === 0){
      const empty = document.createElement("div");
      empty.className = "empty";
      empty.textContent = "Aucun participant. Ajoute des noms ci-dessus.";
      box.appendChild(empty);
      return;
    }

    state.participants.forEach((p, idx) => {
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="item-left">
          <div class="item-name">${escapeHtml(p.name)}</div>
          <div class="item-meta">#${idx+1}</div>
        </div>
        <div class="item-actions">
          <button class="icon-btn" data-act="up" title="Monter" type="button">↑</button>
          <button class="icon-btn" data-act="down" title="Descendre" type="button">↓</button>
          <button class="btn btn-danger btn-sm" data-act="del" type="button">Suppr.</button>
        </div>
      `;

      el.addEventListener("click", (e) => {
        const b = e.target.closest("button");
        if (!b) return;
        const act = b.dataset.act;

        if (act === "del"){
          state.participants = state.participants.filter(x => x.id !== p.id);
          state.groups = null;
          state.bracket = null;
          renderAll();
          toast("Participant supprimé. Poules/bracket réinitialisés.");
        }
        if (act === "up" && idx > 0){
          [state.participants[idx-1], state.participants[idx]] = [state.participants[idx], state.participants[idx-1]];
          renderParticipants();
        }
        if (act === "down" && idx < state.participants.length - 1){
          [state.participants[idx+1], state.participants[idx]] = [state.participants[idx], state.participants[idx+1]];
          renderParticipants();
        }
      });

      box.appendChild(el);
    });
  }

  function addParticipant(name){
    const n = normalizeName(name);
    if (!n) return toast("Nom vide.");
    const exists = state.participants.some(p => p.name.toLowerCase() === n.toLowerCase());
    if (exists) return toast("Ce nom existe déjà.");
    state.participants.push({ id: uid(), name: n });
    $("#nameInput").value = "";
    state.groups = null;
    state.bracket = null;
    renderAll();
  }

  // ----------------- Groups -----------------
  function makeRoundRobinMatches(players){
    const ids = players.map(p => p.id);
    const list = ids.slice();
    if (list.length % 2 === 1) list.push(null);

    const n = list.length;
    const rounds = n - 1;
    const half = n / 2;

    const matches = [];
    let arr = list.slice();
    for (let r = 0; r < rounds; r++){
      for (let i = 0; i < half; i++){
        const a = arr[i];
        const b = arr[n - 1 - i];
        if (a !== null && b !== null){
          matches.push({
            id: uid(),
            aId: a, bId: b,
            aScore: null, bScore: null,
            done: false,
            winnerId: null
          });
        }
      }
      const fixed = arr[0];
      const rest = arr.slice(1);
      rest.unshift(rest.pop());
      arr = [fixed, ...rest];
    }
    return matches;
  }

  function computeTable(group){
    const stats = {};
    group.players.forEach(p => {
      stats[p.id] = { id:p.id, name:p.name, pld:0, w:0, d:0, l:0, gf:0, ga:0, gd:0, pts:0 };
    });

    group.matches.forEach(m => {
      if (!m.done) return;
      const A = stats[m.aId], B = stats[m.bId];
      const as = m.aScore, bs = m.bScore;
      A.pld++; B.pld++;
      A.gf += as; A.ga += bs;
      B.gf += bs; B.ga += as;
      if (as > bs){ A.w++; B.l++; A.pts += 3; }
      else if (as < bs){ B.w++; A.l++; B.pts += 3; }
      else { A.d++; B.d++; A.pts += 1; B.pts += 1; }
    });

    Object.values(stats).forEach(s => s.gd = s.gf - s.ga);

    return Object.values(stats).sort((x,y) => {
      if (y.pts !== x.pts) return y.pts - x.pts;
      if (y.gd !== x.gd) return y.gd - x.gd;
      if (y.gf !== x.gf) return y.gf - x.gf;
      return x.name.localeCompare(y.name);
    });
  }

  function generateGroups(){
    const nPlayers = state.participants.length;
    if (nPlayers < 2) return toast("Ajoute au moins 2 participants.");
    const gCount = clampInt($("#groupsCount").value, 2);
    const qualify = clampInt($("#qualifyPerGroup").value, 2);

    if (gCount > nPlayers) return toast("Plus de poules que de participants.");
    if (qualify < 1) return toast("Qualifiés/poule invalide.");

    const groups = Array.from({length: gCount}, (_,i) => ({
      name: `Poule ${String.fromCharCode(65+i)}`,
      players: [],
      matches: []
    }));

    state.participants.forEach((p, i) => {
      groups[i % gCount].players.push(p);
    });

    groups.forEach(g => { g.matches = makeRoundRobinMatches(g.players); });

    state.groups = { groups, qualifyPerGroup: qualify, createdAt: Date.now() };
    state.bracket = null;
    renderAll();
    toast("Poules générées.");
  }

  function resetGroups(){
    state.groups = null;
    state.bracket = null;
    renderAll();
    toast("Poules réinitialisées.");
  }

  // ----------------- Bracket -----------------
  function nextPowerOfTwo(n){
    let p = 1;
    while (p < n) p *= 2;
    return p;
  }

  function makeBracketMatch(a, b){
    return {
      id: uid(),
      a: a ? { id:a.id, name:a.name, isBye: !!a.isBye } : null,
      b: b ? { id:b.id, name:b.name, isBye: !!b.isBye } : null,
      aScore: null,
      bScore: null,
      done: false,
      winner: null,
      badge: null
    };
  }

  function isByeMatch(m){
    const aBye = !m.a || m.a.isBye || m.a.id === null;
    const bBye = !m.b || m.b.isBye || m.b.id === null;
    const aReal = m.a && m.a.id !== null && !m.a.isBye;
    const bReal = m.b && m.b.id !== null && !m.b.isBye;
    return (aReal && bBye) || (bReal && aBye);
  }

  function placeWinner(rounds, rIndex, mIndex, winner){
    const nextR = rIndex + 1;
    if (!rounds[nextR]) return;
    const nextM = rounds[nextR][Math.floor(mIndex/2)];
    const slot = (mIndex % 2 === 0) ? "a" : "b";
    nextM[slot] = { id:winner.id, name:winner.name, isBye:false };

    if (isByeMatch(nextM)){
      const w = nextM.a && nextM.a.id !== null && !nextM.a.isBye ? nextM.a
              : (nextM.b && nextM.b.id !== null && !nextM.b.isBye ? nextM.b : null);
      if (w){
        nextM.done = true;
        nextM.winner = w;
        nextM.badge = "BYE";
        placeWinner(rounds, nextR, Math.floor(mIndex/2), w);
      }
    }
  }

  function buildBracketFromQualified(){
    if (!state.groups) return toast("Génère d'abord les poules.");
    const qualify = state.groups.qualifyPerGroup;

    const qualified = [];
    state.groups.groups.forEach(g => {
      const table = computeTable(g);
      table.slice(0, qualify).forEach((row, idx) => {
        qualified.push({
          id: row.id,
          name: row.name,
          seedPos: idx+1,
          pts: row.pts,
          gd: row.gd,
          gf: row.gf
        });
      });
    });

    if (qualified.length < 2) return toast("Pas assez de qualifiés pour un bracket.");

    qualified.sort((a,b) => {
      if (a.seedPos !== b.seedPos) return a.seedPos - b.seedPos;
      if (b.pts !== a.pts) return b.pts - a.pts;
      if (b.gd !== a.gd) return b.gd - a.gd;
      if (b.gf !== a.gf) return b.gf - a.gf;
      return a.name.localeCompare(b.name);
    });

    const target = nextPowerOfTwo(qualified.length);
    while (qualified.length < target){
      qualified.push({ id: null, name: "BYE", isBye: true });
    }

    const firstRound = [];
    const n = qualified.length;
    for (let i = 0; i < n/2; i++){
      const a = qualified[i];
      const b = qualified[n-1-i];
      firstRound.push(makeBracketMatch(a, b));
    }

    const rounds = [firstRound];
    let matchesThisRound = firstRound.length;
    while (matchesThisRound > 1){
      matchesThisRound = matchesThisRound / 2;
      rounds.push(Array.from({length: matchesThisRound}, () => makeBracketMatch(null, null)));
    }

    // auto BYE
    firstRound.forEach((m, idx) => {
      if (isByeMatch(m)){
        const winner = m.a && !m.a.isBye ? m.a : (m.b && !m.b.isBye ? m.b : null);
        if (winner){
          m.done = true;
          m.winner = winner;
          m.badge = "BYE";
          placeWinner(rounds, 0, idx, winner);
        }
      }
    });

    state.bracket = { rounds, createdAt: Date.now() };
    renderAll();
    toast("Bracket créé.");
  }

  function resetBracket(){
    state.bracket = null;
    renderAll();
    toast("Bracket réinitialisé.");
  }

  // ----------------- Render -----------------
  function findName(id){
    const p = state.participants.find(x => x.id === id);
    return p ? p.name : "Inconnu";
  }

  function renderGroups(){
    const wrap = $("#groupsView");
    wrap.innerHTML = "";

    if (!state.groups){
      $("#groupsMeta").textContent = "—";
      const hint = document.createElement("div");
      hint.className = "empty";
      hint.textContent = "Génère des poules pour afficher les matchs et le classement.";
      wrap.appendChild(hint);
      return;
    }

    $("#groupsMeta").textContent = `${state.groups.groups.length} poule(s) • ${state.groups.qualifyPerGroup} qualifié(s)/poule`;

    state.groups.groups.forEach((g, gi) => {
      const groupEl = document.createElement("div");
      groupEl.className = "panel";

      const table = computeTable(g);
      groupEl.innerHTML = `
        <div class="panel-hd">
          <div class="panel-title">${escapeHtml(g.name)}</div>
          <span class="pill">${g.players.length} joueurs</span>
        </div>

        <div class="panel-bd">
          <div class="panel-block">
            <div class="panel-label">Classement</div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>#</th><th>Joueur</th><th>MJ</th><th>V</th><th>N</th><th>D</th><th>BP</th><th>BC</th><th>Diff</th><th>Pts</th>
                  </tr>
                </thead>
                <tbody>
                  ${table.map((r, idx) => {
                    const q = idx < state.groups.qualifyPerGroup ? ` <span class="q">Q</span>` : "";
                    return `
                      <tr>
                        <td>${idx+1}</td>
                        <td>${escapeHtml(r.name)}${q}</td>
                        <td>${r.pld}</td><td>${r.w}</td><td>${r.d}</td><td>${r.l}</td>
                        <td>${r.gf}</td><td>${r.ga}</td><td>${r.gd}</td><td><b>${r.pts}</b></td>
                      </tr>
                    `;
                  }).join("")}
                </tbody>
              </table>
            </div>
          </div>

          <div class="panel-block">
            <div class="panel-label">Matchs</div>
            <div class="matches" id="groupMatches-${gi}"></div>
          </div>
        </div>
      `;
      wrap.appendChild(groupEl);

      const matchesBox = groupEl.querySelector(`#groupMatches-${gi}`);

      g.matches.forEach((m) => {
        const aName = findName(m.aId);
        const bName = findName(m.bId);
        const status = m.done ? `<span class="badge badge-done">Terminé</span>` : `<span class="badge badge-todo">À jouer</span>`;
        const winner = m.done ? (m.winnerId ? findName(m.winnerId) : null) : null;

        const row = document.createElement("div");
        row.className = "match";
        row.innerHTML = `
          <div class="team">
            <div class="team-top">
              ${status}
              <div class="names">${escapeHtml(aName)} <span class="vs">vs</span> ${escapeHtml(bName)}</div>
            </div>
            ${winner ? `<div class="winner">Vainqueur : <span>${escapeHtml(winner)}</span></div>` : ``}
          </div>
          <div class="score">
            <input class="score-in" type="number" min="0" step="1" placeholder="A" value="${m.aScore ?? ""}" data-k="aScore">
            <input class="score-in" type="number" min="0" step="1" placeholder="B" value="${m.bScore ?? ""}" data-k="bScore">
            <button class="btn ${m.done ? "btn-ghost" : "btn-success"} btn-sm" data-act="save" type="button">
              ${m.done ? "Modifier" : "Valider"}
            </button>
          </div>
        `;

        row.addEventListener("click", (e) => {
          const btn = e.target.closest("button");
          if (!btn) return;
          const aIn = row.querySelector('input[data-k="aScore"]');
          const bIn = row.querySelector('input[data-k="bScore"]');
          const as = clampInt(aIn.value, NaN);
          const bs = clampInt(bIn.value, NaN);

          if (!Number.isFinite(as) || !Number.isFinite(bs) || as < 0 || bs < 0){
            return toast("Scores invalides.");
          }

          m.aScore = as;
          m.bScore = bs;
          m.done = true;
          if (as > bs) m.winnerId = m.aId;
          else if (bs > as) m.winnerId = m.bId;
          else m.winnerId = null;

          state.bracket = null;
          renderAll();
          toast("Match enregistré. Classement mis à jour.");
        });

        matchesBox.appendChild(row);
      });
    });
  }

  function renderBracket(){
    const wrap = $("#bracketView");
    wrap.innerHTML = "";

    if (!state.bracket){
      $("#bracketMeta").textContent = "—";
      const hint = document.createElement("div");
      hint.className = "empty";
      hint.textContent = "Crée le bracket pour la phase à élimination directe.";
      wrap.appendChild(hint);
      return;
    }

    const rounds = state.bracket.rounds;
    $("#bracketMeta").textContent = `${rounds.length} tour(s)`;

    rounds.forEach((round, rIndex) => {
      const label =
        (rIndex === rounds.length - 1) ? "Finale" :
        (rIndex === rounds.length - 2) ? "Demi-finales" :
        (rIndex === rounds.length - 3) ? "Quarts" :
        `Tour ${rIndex+1}`;

      const roundEl = document.createElement("div");
      roundEl.className = "round";
      roundEl.innerHTML = `
        <div class="round-hd">
          <div class="round-title">${label}</div>
          <span class="pill">${round.length} match(s)</span>
        </div>
        <div class="round-bd" id="round-${rIndex}"></div>
      `;
      wrap.appendChild(roundEl);

      const box = roundEl.querySelector(`#round-${rIndex}`);

      round.forEach((m, mIndex) => {
        const a = m.a ? m.a.name : "—";
        const b = m.b ? m.b.name : "—";
        const canPlay = (m.a && m.a.id !== null && !m.a.isBye) && (m.b && m.b.id !== null && !m.b.isBye);

        let statusTxt = m.done ? "Terminé" : (canPlay ? "À jouer" : "En attente");
        let badgeClass = m.done ? "badge-done" : (canPlay ? "badge-todo" : "badge-wait");
        if (m.badge === "BYE") { statusTxt = "BYE"; badgeClass = "badge-done"; }

        const el = document.createElement("div");
        el.className = "match";
        el.innerHTML = `
          <div class="team">
            <div class="team-top">
              <span class="badge ${badgeClass}">${statusTxt}</span>
              <div class="names">${escapeHtml(a)} <span class="vs">vs</span> ${escapeHtml(b)}</div>
            </div>
            ${m.winner ? `<div class="winner">Vainqueur : <span>${escapeHtml(m.winner.name)}</span></div>` : ``}
          </div>
          <div class="score">
            <input class="score-in" type="number" min="0" step="1" placeholder="A" value="${m.aScore ?? ""}" data-k="aScore" ${!canPlay ? "disabled" : ""}>
            <input class="score-in" type="number" min="0" step="1" placeholder="B" value="${m.bScore ?? ""}" data-k="bScore" ${!canPlay ? "disabled" : ""}>
            <button class="btn ${m.done ? "btn-ghost" : "btn-success"} btn-sm" data-act="save" type="button" ${!canPlay ? "disabled" : ""}>
              ${m.done ? "Modifier" : "Valider"}
            </button>
          </div>
        `;

        el.addEventListener("click", (e) => {
          const btn = e.target.closest("button");
          if (!btn) return;

          const aIn = el.querySelector('input[data-k="aScore"]');
          const bIn = el.querySelector('input[data-k="bScore"]');
          const as = clampInt(aIn.value, NaN);
          const bs = clampInt(bIn.value, NaN);

          if (!Number.isFinite(as) || !Number.isFinite(bs) || as < 0 || bs < 0){
            return toast("Scores invalides.");
          }
          if (as === bs){
            return toast("Élimination directe : pas de match nul.");
          }

          m.aScore = as;
          m.bScore = bs;
          m.done = true;
          m.winner = (as > bs) ? m.a : m.b;
          m.badge = null;

          placeWinner(rounds, rIndex, mIndex, m.winner);
          renderAll();
          toast(rIndex === rounds.length - 1 ? "Finale terminée !" : "Vainqueur envoyé au tour suivant.");
        });

        box.appendChild(el);
      });
    });
  }

  // ----------------- Export / Import -----------------
  function exportJson(){
    const data = JSON.stringify(state, null, 2);
    const blob = new Blob([data], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "bracketflow.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    toast("Export JSON téléchargé.");
  }

  function importJsonFile(file){
    const r = new FileReader();
    r.onload = () => {
      try{
        const obj = JSON.parse(r.result);
        if (!obj || !Array.isArray(obj.participants)) throw new Error("Format invalide");
        state.participants = obj.participants;
        state.groups = obj.groups ?? null;
        state.bracket = obj.bracket ?? null;
        renderAll();
        toast("Import JSON OK.");
      } catch {
        toast("Import impossible (JSON invalide).");
      }
    };
    r.readAsText(file);
  }

  // ----------------- Render all -----------------
  function renderAll(){
    renderParticipants();
    renderGroups();
    renderBracket();

    if (!state.groups && !state.bracket) setStatus("Prêt");
    else if (state.groups && !state.bracket) setStatus("Poules");
    else setStatus("Élimination");
  }

  // ----------------- Wire up -----------------
  $("#addBtn").addEventListener("click", () => addParticipant($("#nameInput").value));
  $("#nameInput").addEventListener("keydown", (e) => {
    if (e.key === "Enter") addParticipant($("#nameInput").value);
  });

  $("#shuffleBtn").addEventListener("click", () => {
    if (state.participants.length < 2) return toast("Pas assez de participants.");
    shuffle(state.participants);
    state.groups = null;
    state.bracket = null;
    renderAll();
    toast("Ordre mélangé.");
  });

  $("#clearBtn").addEventListener("click", () => {
    state.participants = [];
    state.groups = null;
    state.bracket = null;
    renderAll();
    toast("Tout effacé.");
  });

  $("#bulkBtn").addEventListener("click", () => {
    const raw = $("#bulkInput").value || "";
    const parts = raw.split(",").map(normalizeName).filter(Boolean);
    if (parts.length === 0) return toast("Rien à importer.");
    let added = 0;
    parts.forEach(n => {
      if (!state.participants.some(p => p.name.toLowerCase() === n.toLowerCase())){
        state.participants.push({ id: uid(), name: n });
        added++;
      }
    });
    $("#bulkInput").value = "";
    state.groups = null;
    state.bracket = null;
    renderAll();
    toast(`${added} participant(s) importé(s).`);
  });

  $("#makeGroupsBtn").addEventListener("click", generateGroups);
  $("#resetGroupsBtn").addEventListener("click", resetGroups);
  $("#makeBracketBtn").addEventListener("click", buildBracketFromQualified);
  $("#resetBracketBtn").addEventListener("click", resetBracket);

  // Footer links
  $("#demoBtn").addEventListener("click", (e) => {
    e.preventDefault();
    state.participants = ["Alex","Sam","Nina","Léo","Maya","Hugo","Inès","Noah","Emma","Tom","Zoé","Rayan"]
      .map(n => ({ id: uid(), name: n }));
    state.groups = null;
    state.bracket = null;
    renderAll();
    toast("Démo chargée.");
  });
  $("#exportBtn").addEventListener("click", (e) => { e.preventDefault(); exportJson(); });
  $("#importBtn").addEventListener("click", (e) => { e.preventDefault(); $("#fileInput").click(); });

  // Topbar quick actions
  $("#demoBtnTop").addEventListener("click", () => $("#demoBtn").click());
  $("#exportBtnTop").addEventListener("click", exportJson);
  $("#importBtnTop").addEventListener("click", () => $("#fileInput").click());

  $("#fileInput").addEventListener("change", (e) => {
    const file = e.target.files?.[0];
    if (file) importJsonFile(file);
    e.target.value = "";
  });

  // Init
  $("#year").textContent = new Date().getFullYear();
  setStatus("Prêt");
  renderAll();
})();
</script>
</body>
</html>
